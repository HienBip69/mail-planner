<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>B·∫£ng ƒëi·ªÅu khi·ªÉn k·∫ø ho·∫°ch</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- ‚úÖ ƒê·∫£m b·∫£o responsive -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .done-task {
            opacity: 0.5;
            text-decoration: line-through;
        }

        /* ‚úÖ Responsive font v√† n√∫t cho mobile */
        @media (max-width: 768px) {
            .card-body {
                font-size: 1rem;
                padding: 1rem;
            }
            .card-title {
                font-size: 1.25rem;
            }
            button.btn {
                width: 100%;
                margin-top: 10px;
            }
            pre {
                white-space: pre-wrap;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body class="bg-white">
<div class="container mt-4 mb-5">
    <h2 class="mb-3 text-center">üìÖ K·∫ø ho·∫°ch t·ª´ Email</h2>

    <!-- ‚è≥ Countdown -->
    <div class="mb-3 text-center">
        <h6 class="text-primary">
            ‚è≥ L·∫ßn ki·ªÉm tra email ti·∫øp theo trong <span id="countdown" class="fw-bold">...</span> gi√¢y.
        </h6>
    </div>

    <!-- üîç T√¨m ki·∫øm & l·ªçc -->
    <div class="mb-3 row g-2">
        <div class="col-md-8">
            <input type="text" class="form-control" id="searchBox" placeholder="üîç T√¨m theo ti√™u ƒë·ªÅ...">
        </div>
        <div class="col-md-4 d-flex align-items-center">
            <input class="form-check-input me-2" type="checkbox" id="hideDone" checked>
            <label class="form-check-label" for="hideDone">Ch·ªâ hi·ªÉn th·ªã ch∆∞a ho√†n th√†nh</label>
        </div>
    </div>

    <!-- üîî Log -->
    <div id="log" class="mb-4 text-muted small"></div>

    {% if plans %}
        <div id="taskList">
            {% for task in plans %}
                <div class="card mb-3 shadow-sm task-item {% if task.done %}done-task{% endif %}" 
                     data-title="{{ task.title|lower }}" data-done="{{ '1' if task.done else '0' }}">
                    <div class="card-body">
                        <h5 class="card-title">{{ task.title }}</h5>
                        <p><strong>H·∫°n ch√≥t:</strong> {{ task.deadline }}</p>
                        <p><strong>T·ªïng th·ªùi gian:</strong> {{ task.total_hours }} gi·ªù, 
                           <strong>M·ªói ng√†y:</strong> {{ task.hours_per_day }} gi·ªù</p>
                        <p><strong>M√¥ t·∫£:</strong> {{ task.description }}</p>
                        <hr>
                        <pre>{{ task.plan }}</pre>
                        <form action="{{ url_for('toggle_done', index=loop.index0) }}" method="post" class="mt-2">
                            <button type="submit" class="btn btn-sm {{ 'btn-secondary' if task.done else 'btn-success' }}">
                                {{ '‚úÖ ƒê√£ ho√†n th√†nh' if task.done else 'ƒê√°nh d·∫•u ho√†n th√†nh' }}
                            </button>
                        </form>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p class="text-center text-muted">üìù Ch∆∞a c√≥ k·∫ø ho·∫°ch n√†o ƒë∆∞·ª£c l·∫≠p.</p>
    {% endif %}
</div>

<!-- ‚úÖ JavaScript -->
<script>
    const evtSource = new EventSource("/stream");
    evtSource.onmessage = function(event) {
        const data = JSON.parse(event.data);
        if (data.message) {
            const log = document.getElementById("log");
            const p = document.createElement("p");
            p.textContent = data.message;
            log.prepend(p);
        }
        if (data.countdown !== undefined) {
            const seconds = data.countdown;
            document.getElementById("countdown").textContent = seconds >= 0 ? seconds : "ƒêang x·ª≠ l√Ω";
        }
    };

    const searchBox = document.getElementById("searchBox");
    const hideDone = document.getElementById("hideDone");

    function filterTasks() {
        const keyword = searchBox.value.toLowerCase();
        const hideDoneChecked = hideDone.checked;

        document.querySelectorAll(".task-item").forEach(task => {
            const title = task.getAttribute("data-title");
            const isDone = task.getAttribute("data-done") === "1";

            const matchTitle = title.includes(keyword);
            const matchDone = !hideDoneChecked || !isDone;

            task.style.display = (matchTitle && matchDone) ? "" : "none";
        });
    }

    searchBox.addEventListener("input", filterTasks);
    hideDone.addEventListener("change", filterTasks);
</script>
</body>
</html>
